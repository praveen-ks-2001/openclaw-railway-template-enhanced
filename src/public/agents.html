<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ü¶û OpenClaw ‚Äî Agents Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/zdog@1/dist/zdog.dist.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style type="text/tailwindcss">
    @theme {
      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      --color-surface: #09090b;
      --color-surface-raised: rgba(255, 255, 255, 0.03);
      --color-surface-overlay: rgba(255, 255, 255, 0.06);
      --color-border: rgba(255, 255, 255, 0.07);
      --color-border-muted: rgba(255, 255, 255, 0.04);
      --color-accent: #e63946;
      --color-accent-hover: #f04d5a;
      --color-text-primary: #fafafa;
      --color-text-secondary: #a1a1aa;
      --color-text-muted: #52525b;
      --color-success: #22c55e;
      --color-warning: #eab308;
      --color-danger: #ef4444;
    }
    [x-cloak] { display: none !important; }
    body { background: var(--color-surface); }

    body::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(230,57,70,0.3), transparent);
      z-index: 100; pointer-events: none;
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.14); }

    .card {
      background: var(--color-surface-raised);
      border: 1px solid var(--color-border-muted);
      border-radius: 18px; padding: 24px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      border-color: var(--color-border);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02), 0 8px 32px rgba(0,0,0,0.12);
    }

    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 500;
    }
    .badge-success { background: rgba(34,197,94,0.1); color: #4ade80; border: 1px solid rgba(34,197,94,0.15); }
    .badge-warning { background: rgba(234,179,8,0.1); color: #facc15; border: 1px solid rgba(234,179,8,0.15); }
    .badge-danger  { background: rgba(239,68,68,0.1); color: #f87171; border: 1px solid rgba(239,68,68,0.15); }
    .badge-muted   { background: rgba(255,255,255,0.04); color: #a1a1aa; border: 1px solid rgba(255,255,255,0.06); }
    .badge-accent  { background: rgba(230,57,70,0.1); color: #f04d5a; border: 1px solid rgba(230,57,70,0.15); }

    .pulse-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }
    .pulse-dot.green  { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.4); }
    .pulse-dot.yellow { background: #eab308; box-shadow: 0 0 8px rgba(234,179,8,0.4); animation: pulse 2s infinite; }
    .pulse-dot.red    { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.4); }
    .pulse-dot.gray   { background: #52525b; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }

    /* Agent avatar ring */
    @keyframes ring-rotate { to { transform: rotate(360deg); } }
    @keyframes ring-pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .agent-ring-active {
      animation: ring-rotate 8s linear infinite;
    }
    .agent-ring-pulse {
      animation: ring-pulse 3s ease-in-out infinite;
    }

    /* Flowing connection line */
    @keyframes flow {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }
    .flow-line {
      stroke-dasharray: 5,5;
      animation: flow 1s linear infinite;
    }

    .file-tree { font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace; font-size: 13px; }
    .file-tree-item {
      padding: 4px 8px; display: flex; align-items: center; gap: 8px;
      border-radius: 8px; cursor: pointer; transition: background 0.15s;
      user-select: none; position: relative;
    }
    .file-tree-item:hover { background: rgba(255,255,255,0.04); color: var(--color-text-primary); }
    .file-tree-item.selected { background: rgba(230,57,70,0.1); color: var(--color-text-primary); }
    .file-tree-item.drag-over { background: rgba(34,197,94,0.12); outline: 1px dashed rgba(34,197,94,0.4); }
    .file-tree-item[draggable="true"] { cursor: grab; }
    .file-tree-item[draggable="true"]:active { cursor: grabbing; }

    .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; line-height: 1; }
    .stat-label { font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Context menu */
    .ctx-menu {
      position: fixed; z-index: 9999; min-width: 180px;
      background: #1c1c1e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 4px; box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      font-size: 13px;
    }
    .ctx-menu-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 12px; border-radius: 8px; cursor: pointer;
      color: var(--color-text-secondary); transition: background 0.12s;
    }
    .ctx-menu-item:hover { background: rgba(255,255,255,0.07); color: var(--color-text-primary); }
    .ctx-menu-item.danger { color: #f87171; }
    .ctx-menu-item.danger:hover { background: rgba(239,68,68,0.12); }
    .ctx-menu-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 4px 8px; }

    /* File editor modal */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 9998;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
    }
    .modal-box {
      background: #0f0f11; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px; width: 90vw; max-width: 900px; height: 80vh;
      display: flex; flex-direction: column; overflow: hidden;
      box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    }
    .modal-header {
      padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; gap: 12px;
    }
    .modal-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .modal-body textarea {
      flex: 1; width: 100%; resize: none; border: none; outline: none;
      background: transparent; color: var(--color-text-primary);
      font-family: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace;
      font-size: 13px; line-height: 1.6; padding: 16px 20px; tab-size: 2;
    }
    .modal-footer {
      padding: 12px 20px; border-top: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; justify-content: space-between;
    }

    /* Inline rename input */
    .inline-rename {
      background: rgba(255,255,255,0.06); border: 1px solid rgba(230,57,70,0.4);
      color: var(--color-text-primary); border-radius: 4px; padding: 1px 6px;
      font-family: inherit; font-size: inherit; outline: none; width: 180px;
    }

    /* Prompt dialog */
    .prompt-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
      display: flex; align-items: center; justify-content: center;
    }
    .prompt-box {
      background: #1c1c1e; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; padding: 24px; width: 380px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
    }
    .prompt-input {
      width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      color: var(--color-text-primary); border-radius: 10px; padding: 10px 14px;
      font-family: 'JetBrains Mono', monospace; font-size: 13px; outline: none;
      margin: 12px 0 16px;
    }
    .prompt-input:focus { border-color: rgba(230,57,70,0.4); }

    /* Expand/collapse arrow */
    .tree-arrow {
      width: 16px; height: 16px; display: inline-flex; align-items: center;
      justify-content: center; font-size: 10px; color: var(--color-text-muted);
      transition: transform 0.15s; flex-shrink: 0;
    }
    .tree-arrow.expanded { transform: rotate(90deg); }

    /* ‚îÄ‚îÄ Office Visualization ‚îÄ‚îÄ */
    #officeVizWrap {
      position: relative; width: 100%; height: 320px;
      border-radius: 18px; overflow: hidden;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border: 1px solid var(--color-border-muted);
      margin-bottom: 24px;
    }
    #officeViz { display: block; width: 100%; height: 100%; cursor: pointer; }
    #officeLabels { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
    .agentLabel {
      position: absolute; transform: translate(-50%, -100%);
      font: 11px/1.2 'Inter', system-ui, sans-serif;
      background: rgba(15,15,20,0.82); color: #eee;
      padding: 3px 7px; border-radius: 6px;
      white-space: nowrap; pointer-events: none;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(4px);
      transition: opacity 0.15s;
    }
    .agentLabel .agentName { font-weight: 600; font-size: 11px; }
    .agentLabel .agentStatus { font-size: 10px; opacity: 0.7; display: flex; align-items: center; gap: 4px; }
    .agentLabel .statusDot {
      display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    }
    .agentLabel.selected { border-color: rgba(230,57,70,0.5); box-shadow: 0 0 8px rgba(230,57,70,0.25); }
    .card.viz-selected { border-color: rgba(230,57,70,0.35) !important; box-shadow: 0 0 0 1px rgba(230,57,70,0.1), 0 0 20px rgba(230,57,70,0.08) !important; }
  </style>
</head>

<body class="font-sans text-[var(--color-text-secondary)] min-h-screen antialiased">
<div x-data="agentsDashboard()" x-init="init()" class="max-w-6xl mx-auto px-4 sm:px-6 py-8">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OFFICE VISUALIZATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="officeVizWrap">
    <canvas id="officeViz"></canvas>
    <div id="officeLabels"></div>
  </div>

  <!-- Header -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
    <div>
      <h1 class="text-2xl font-bold text-[var(--color-text-primary)] flex items-center gap-3">
        <span class="text-3xl">ü¶û</span>
        Agents Dashboard
      </h1>
      <p class="text-sm mt-1 text-[var(--color-text-muted)]">
        Visual overview of your OpenClaw agents, channels &amp; system
      </p>
    </div>
    <div class="flex items-center gap-3">
      <a href="/setup" class="text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors px-3 py-1.5 rounded-lg border border-[var(--color-border-muted)] hover:border-[var(--color-border)]">
        ‚Üê Setup
      </a>
      <button @click="refresh()" :disabled="loading"
        class="text-sm text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors px-3 py-1.5 rounded-lg border border-[rgba(230,57,70,0.15)] hover:border-[rgba(230,57,70,0.3)] disabled:opacity-50">
        <span x-show="!loading">‚Üª Refresh</span>
        <span x-show="loading" class="flex items-center gap-2">
          <svg class="w-3.5 h-3.5 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
          Loading‚Ä¶
        </span>
      </button>
    </div>
  </div>

  <!-- Error banner -->
  <div x-show="error" x-cloak class="mb-6 p-4 rounded-xl bg-[rgba(239,68,68,0.08)] border border-[rgba(239,68,68,0.15)] text-sm text-[#f87171]">
    <span x-text="error"></span>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MAIN AGENT VISUAL ‚Äî big hero card with avatar + status
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card mb-8 relative overflow-hidden" :class="{ 'viz-selected': selectedVizAgent === '__main__' }">
    <!-- Subtle gradient bg -->
    <div class="absolute inset-0 opacity-30 pointer-events-none"
         style="background: radial-gradient(ellipse at 30% 20%, rgba(230,57,70,0.08) 0%, transparent 60%);"></div>

    <div class="relative flex flex-col lg:flex-row gap-8 items-start lg:items-center">

      <!-- Agent Avatar -->
      <div class="flex flex-col items-center gap-3 min-w-[160px]">
        <div class="relative">
          <!-- Outer animated ring -->
          <svg class="w-28 h-28" :class="gatewayOk ? 'agent-ring-active' : ''" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" :stop-color="gatewayOk ? '#22c55e' : '#52525b'" stop-opacity="0.8"/>
                <stop offset="50%" :stop-color="gatewayOk ? '#4ade80' : '#71717a'" stop-opacity="0.2"/>
                <stop offset="100%" :stop-color="gatewayOk ? '#22c55e' : '#52525b'" stop-opacity="0.8"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="55" fill="none" stroke="url(#ringGrad)" stroke-width="2"
                    stroke-dasharray="8,4" :class="gatewayOk ? '' : ''" />
          </svg>
          <!-- Inner circle with emoji -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-20 h-20 rounded-full flex items-center justify-center text-4xl"
                 :class="gatewayOk ? 'bg-[rgba(34,197,94,0.08)] border-2 border-[rgba(34,197,94,0.2)]'
                                    : 'bg-[rgba(82,82,91,0.15)] border-2 border-[rgba(82,82,91,0.2)]'">
              ü¶û
            </div>
          </div>
        </div>
        <div class="text-center">
          <div class="text-[15px] font-bold text-[var(--color-text-primary)]">Main Agent</div>
          <template x-if="gatewayOk">
            <span class="badge badge-success mt-1"><span class="pulse-dot green"></span> Running</span>
          </template>
          <template x-if="status.gateway?.starting && !gatewayOk">
            <span class="badge badge-warning mt-1"><span class="pulse-dot yellow"></span> Starting</span>
          </template>
          <template x-if="!gatewayOk && !status.gateway?.starting">
            <span class="badge badge-danger mt-1"><span class="pulse-dot red"></span> Offline</span>
          </template>
        </div>
      </div>

      <!-- Agent Details -->
      <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-10 gap-y-3 text-sm">
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Primary Model</span>
          <div class="text-[var(--color-text-primary)] font-semibold mt-0.5"
               x-text="overview.agents?.model?.primary || overview.model || '(default)'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Workspace</span>
          <div class="text-[var(--color-text-primary)] font-mono text-xs mt-0.5"
               x-text="overview.agents?.workspace || '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Max Concurrent</span>
          <div class="text-[var(--color-text-primary)] font-semibold mt-0.5"
               x-text="overview.agents?.maxConcurrent ?? '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Subagent Concurrency</span>
          <div class="text-[var(--color-text-primary)] font-semibold mt-0.5"
               x-text="overview.agents?.subagents?.maxConcurrent ?? '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Compaction</span>
          <div class="text-[var(--color-text-primary)] mt-0.5"
               x-text="overview.agents?.compaction?.mode || '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Version</span>
          <div class="text-[var(--color-text-primary)] font-mono text-xs mt-0.5"
               x-text="overview.openclawVersion || '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Session Scope</span>
          <div class="text-[var(--color-text-primary)] mt-0.5"
               x-text="overview.session?.dmScope || '‚Äî'"></div>
        </div>
        <div>
          <span class="text-[var(--color-text-muted)] text-xs uppercase tracking-wider">Memory (RSS)</span>
          <div class="text-[var(--color-text-primary)] font-mono text-xs mt-0.5"
               x-text="formatBytes(status.memory?.rss)"></div>
        </div>
      </div>

      <!-- Model aliases sidebar -->
      <div class="lg:border-l lg:border-[var(--color-border-muted)] lg:pl-8 min-w-[160px]">
        <div class="text-xs text-[var(--color-text-muted)] uppercase tracking-wider mb-3">Models</div>
        <div class="space-y-2">
          <template x-for="(cfg, id) in (overview.agents?.models || {})" :key="id">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-[var(--color-accent)]"></span>
              <div>
                <div class="text-xs text-[var(--color-text-primary)] font-medium" x-text="cfg.alias || id"></div>
                <div class="text-[11px] text-[var(--color-text-muted)] font-mono" x-text="id"></div>
              </div>
            </div>
          </template>
          <template x-if="Object.keys(overview.agents?.models || {}).length === 0">
            <span class="text-xs text-[var(--color-text-muted)] italic">No model aliases</span>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CHANNEL AGENTS ‚Äî visual cards with connection lines
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-5">
      <h2 class="text-lg font-bold text-[var(--color-text-primary)]">Channel Agents</h2>
      <span class="badge badge-muted" x-text="channelCount + ' connected'"></span>
    </div>

    <template x-if="channelCount === 0">
      <div class="card text-center py-14">
        <p class="text-5xl mb-4">üì≠</p>
        <p class="text-[var(--color-text-muted)]">No channels configured yet.</p>
        <a href="/setup" class="inline-block mt-3 text-sm text-[var(--color-accent)] hover:text-[var(--color-accent-hover)]">Go to Setup ‚Üí</a>
      </div>
    </template>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
      <template x-for="(cfg, name) in (overview.channels || {})" :key="name">
        <div class="card !p-0 overflow-hidden group" :class="{ 'viz-selected': selectedVizAgent === ('ch_' + name) }">
          <!-- Channel header with colored accent -->
          <div class="p-5 pb-4 relative">
            <!-- Top accent bar -->
            <div class="absolute top-0 left-0 right-0 h-[3px]"
                 :style="'background: ' + channelColor(name)"></div>

            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-4">
                <!-- Channel Avatar -->
                <div class="relative">
                  <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl transition-transform group-hover:scale-105"
                       :style="'background: ' + channelColor(name) + '15; border: 1px solid ' + channelColor(name) + '30'">
                    <span x-text="channelIcon(name)"></span>
                  </div>
                  <!-- Status pip -->
                  <div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center"
                       :class="cfg.enabled ? 'bg-[rgba(34,197,94,0.15)] border border-[rgba(34,197,94,0.3)]'
                                            : 'bg-[rgba(82,82,91,0.2)] border border-[rgba(82,82,91,0.3)]'">
                    <span class="pulse-dot" :class="cfg.enabled && gatewayOk ? 'green' : (cfg.enabled ? 'yellow' : 'gray')"
                          style="width:8px;height:8px;"></span>
                  </div>
                </div>

                <div>
                  <h3 class="text-base font-bold text-[var(--color-text-primary)] capitalize" x-text="name"></h3>
                  <template x-if="cfg.enabled && gatewayOk">
                    <span class="text-xs text-[#4ade80] font-medium">‚óè Active ‚Äî Listening</span>
                  </template>
                  <template x-if="cfg.enabled && !gatewayOk">
                    <span class="text-xs text-[#facc15] font-medium">‚óè Enabled ‚Äî Gateway Down</span>
                  </template>
                  <template x-if="!cfg.enabled">
                    <span class="text-xs text-[var(--color-text-muted)] font-medium">‚óã Disabled</span>
                  </template>
                </div>
              </div>
            </div>

            <!-- Channel properties -->
            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
              <template x-for="(val, key) in channelDetails(cfg)" :key="key">
                <div class="flex flex-col">
                  <span class="text-[10px] text-[var(--color-text-muted)] uppercase tracking-wider" x-text="key"></span>
                  <span class="text-xs text-[var(--color-text-secondary)] font-medium" x-text="String(val)"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Bottom bar -->
          <div class="px-5 py-3 bg-[var(--color-surface-overlay)] border-t border-[var(--color-border-muted)] flex items-center justify-between">
            <span class="text-[11px] text-[var(--color-text-muted)]">
              Credentials: <span :class="cfg.hasToken ? 'text-[#4ade80]' : 'text-[#f87171]'"
                                  x-text="cfg.hasToken ? '‚úì Present' : '‚úó Missing'"></span>
            </span>
            <template x-if="cfg.enabled && gatewayOk">
              <span class="badge badge-success !py-0.5 !text-[10px]">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Live
              </span>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SUBAGENTS VISUAL
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card mb-8" x-show="overview.agents?.maxConcurrent">
    <div class="flex items-center gap-3 mb-5">
      <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">ü§ñ</div>
      <h2 class="text-base font-semibold text-[var(--color-text-primary)]">Agent Slots</h2>
      <span class="text-xs text-[var(--color-text-muted)]">Concurrency pool visualization</span>
    </div>

    <!-- Main agent slots -->
    <div class="mb-5">
      <div class="text-xs text-[var(--color-text-muted)] uppercase tracking-wider mb-3">
        Main Agents <span class="text-[var(--color-text-primary)] font-semibold" x-text="'(' + (overview.agents?.maxConcurrent || 0) + ' max)'"></span>
      </div>
      <div class="flex flex-wrap gap-3">
        <template x-for="i in (overview.agents?.maxConcurrent || 0)" :key="'main-'+i">
          <div class="relative group/slot">
            <div class="w-14 h-14 rounded-xl border-2 flex items-center justify-center text-lg transition-all"
                 :class="i === 1 && gatewayOk
                   ? 'bg-[rgba(34,197,94,0.06)] border-[rgba(34,197,94,0.25)] text-[#4ade80]'
                   : 'bg-[var(--color-surface-overlay)] border-[var(--color-border-muted)] text-[var(--color-text-muted)]'">
              <template x-if="i === 1 && gatewayOk">
                <span>ü¶û</span>
              </template>
              <template x-if="!(i === 1 && gatewayOk)">
                <span class="text-sm font-mono opacity-40" x-text="'#' + i"></span>
              </template>
            </div>
            <!-- Tooltip -->
            <div class="absolute -top-8 left-1/2 -translate-x-1/2 px-2.5 py-1 rounded-lg bg-[#27272a] text-[10px] text-[var(--color-text-primary)] font-medium whitespace-nowrap opacity-0 group-hover/slot:opacity-100 transition-opacity pointer-events-none z-10">
              <span x-text="i === 1 && gatewayOk ? 'Primary ‚Äî Active' : 'Slot #' + i + ' ‚Äî Idle'"></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Subagent slots -->
    <div>
      <div class="text-xs text-[var(--color-text-muted)] uppercase tracking-wider mb-3">
        Sub-agents <span class="text-[var(--color-text-primary)] font-semibold" x-text="'(' + (overview.agents?.subagents?.maxConcurrent || 0) + ' max)'"></span>
      </div>
      <div class="flex flex-wrap gap-2">
        <template x-for="i in (overview.agents?.subagents?.maxConcurrent || 0)" :key="'sub-'+i">
          <div class="relative group/slot">
            <div class="w-10 h-10 rounded-lg border flex items-center justify-center text-xs transition-all bg-[var(--color-surface-overlay)] border-[var(--color-border-muted)] text-[var(--color-text-muted)]">
              <span class="font-mono opacity-40" x-text="'s' + i"></span>
            </div>
            <div class="absolute -top-8 left-1/2 -translate-x-1/2 px-2.5 py-1 rounded-lg bg-[#27272a] text-[10px] text-[var(--color-text-primary)] font-medium whitespace-nowrap opacity-0 group-hover/slot:opacity-100 transition-opacity pointer-events-none z-10">
              <span x-text="'Subagent slot #' + i + ' ‚Äî Idle'"></span>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       COMPACT INFO GRID: Gateway / Devices / Commands / Skills
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

    <!-- Gateway & System -->
    <div class="card">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">‚ö°</div>
        <h2 class="text-base font-semibold text-[var(--color-text-primary)]">Gateway</h2>
        <div class="ml-auto">
          <template x-if="gatewayOk">
            <span class="badge badge-success"><span class="pulse-dot green"></span> Running</span>
          </template>
          <template x-if="status.gateway?.starting">
            <span class="badge badge-warning"><span class="pulse-dot yellow"></span> Starting</span>
          </template>
          <template x-if="!gatewayOk && !status.gateway?.starting">
            <span class="badge badge-danger"><span class="pulse-dot red"></span> Offline</span>
          </template>
        </div>
      </div>
      <div class="space-y-3 text-sm">
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">PID</span><span class="text-[var(--color-text-primary)] font-mono text-xs" x-text="status.gateway?.pid || '‚Äî'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Reachable</span><span :class="status.gateway?.reachable ? 'text-[#4ade80]' : 'text-[var(--color-text-muted)]'" x-text="status.gateway?.reachable ? 'Yes' : 'No'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Node.js</span><span class="text-[var(--color-text-primary)] font-mono text-xs" x-text="status.nodeVersion || '‚Äî'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Uptime</span><span class="text-[var(--color-text-primary)]" x-text="formatUptime(status.uptime)"></span></div>
      </div>
    </div>

    <!-- Devices -->
    <div class="card">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">üì±</div>
        <h2 class="text-base font-semibold text-[var(--color-text-primary)]">Paired Devices</h2>
        <span class="badge badge-muted ml-auto" x-text="deviceCount + ' device(s)'"></span>
      </div>
      <template x-if="deviceCount === 0">
        <p class="text-sm text-[var(--color-text-muted)] italic">No devices paired or gateway not running.</p>
      </template>
      <div class="space-y-2">
        <template x-for="(dev, i) in (status.devices || [])" :key="i">
          <div class="flex items-center justify-between p-3 rounded-xl bg-[var(--color-surface-overlay)]">
            <div class="flex items-center gap-3">
              <span>üíª</span>
              <div>
                <div class="text-sm font-medium text-[var(--color-text-primary)]" x-text="dev.name || dev.id || ('Device ' + (i+1))"></div>
                <div class="text-xs text-[var(--color-text-muted)]" x-text="dev.type || dev.status || ''"></div>
              </div>
            </div>
            <template x-if="dev.connected || dev.status === 'connected'">
              <span class="badge badge-success"><span class="pulse-dot green"></span> Connected</span>
            </template>
            <template x-if="dev.status === 'pending'">
              <span class="badge badge-warning"><span class="pulse-dot yellow"></span> Pending</span>
            </template>
            <template x-if="!dev.connected && dev.status !== 'connected' && dev.status !== 'pending'">
              <span class="badge badge-muted" x-text="dev.status || 'Unknown'"></span>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Commands & Skills -->
    <div class="card">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">‚öôÔ∏è</div>
        <h2 class="text-base font-semibold text-[var(--color-text-primary)]">Commands &amp; Skills</h2>
      </div>
      <div class="space-y-3 text-sm">
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Native commands</span><span class="text-[var(--color-text-primary)]" x-text="overview.commands?.native || '‚Äî'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Native skills</span><span class="text-[var(--color-text-primary)]" x-text="overview.commands?.nativeSkills || '‚Äî'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Restart allowed</span><span :class="overview.commands?.restart ? 'text-[#4ade80]' : 'text-[var(--color-text-muted)]'" x-text="overview.commands?.restart ? 'Yes' : 'No'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">Skill node manager</span><span class="text-[var(--color-text-primary)]" x-text="overview.skills?.install?.nodeManager || '‚Äî'"></span></div>
        <div class="flex justify-between"><span class="text-[var(--color-text-muted)]">ACK scope</span><span class="text-[var(--color-text-primary)]" x-text="overview.messages?.ackReactionScope || '‚Äî'"></span></div>
      </div>
    </div>

    <!-- Auth Providers -->
    <div class="card">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">üîë</div>
        <h2 class="text-base font-semibold text-[var(--color-text-primary)]">Auth Providers</h2>
      </div>
      <template x-if="Object.keys(overview.auth || {}).length === 0">
        <p class="text-sm text-[var(--color-text-muted)] italic">No auth providers in config.</p>
      </template>
      <div class="space-y-2">
        <template x-for="(cfg, name) in (overview.auth || {})" :key="name">
          <div class="flex items-center justify-between p-3 rounded-xl bg-[var(--color-surface-overlay)]">
            <div class="flex items-center gap-3">
              <span class="text-base" x-text="providerIcon(name)"></span>
              <div class="text-sm font-medium text-[var(--color-text-primary)] capitalize" x-text="name"></div>
            </div>
            <span class="badge badge-success">Configured</span>
          </div>
        </template>
      </div>
      <template x-if="overview.configKeys && overview.configKeys.length > 0">
        <div class="mt-4 pt-3 border-t border-[var(--color-border-muted)]">
          <p class="text-[10px] text-[var(--color-text-muted)] uppercase tracking-wider mb-2">Config sections</p>
          <div class="flex flex-wrap gap-1.5">
            <template x-for="key in overview.configKeys" :key="key">
              <span class="text-[11px] font-mono px-2 py-0.5 rounded-md bg-[var(--color-surface-overlay)] text-[var(--color-text-muted)]" x-text="key"></span>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILESYSTEM EXPLORER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card mb-6" x-data="fileExplorer()" @keydown.escape.window="closeAll()">
    <div class="flex items-center gap-3 mb-5">
      <div class="w-9 h-9 rounded-xl bg-[rgba(230,57,70,0.08)] flex items-center justify-center text-lg">üìÇ</div>
      <h2 class="text-base font-semibold text-[var(--color-text-primary)]">File Explorer</h2>

      <!-- Root selector tabs -->
      <div class="flex gap-1 ml-4 bg-[var(--color-surface-overlay)] rounded-lg p-1">
        <button @click="switchRoot('workspace')" class="text-xs px-3 py-1 rounded-md transition-colors"
                :class="currentRoot === 'workspace' ? 'bg-[rgba(230,57,70,0.15)] text-[var(--color-accent)]' : 'text-[var(--color-text-muted)] hover:text-[var(--color-text-secondary)]'">
          Workspace
        </button>
        <button @click="switchRoot('state')" class="text-xs px-3 py-1 rounded-md transition-colors"
                :class="currentRoot === 'state' ? 'bg-[rgba(230,57,70,0.15)] text-[var(--color-accent)]' : 'text-[var(--color-text-muted)] hover:text-[var(--color-text-secondary)]'">
          State
        </button>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button @click="promptNewFile('')" class="text-xs text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] transition-colors px-2 py-1 rounded-lg border border-[var(--color-border-muted)] hover:border-[var(--color-border)]" title="New File">
          + File
        </button>
        <button @click="promptNewFolder('')" class="text-xs text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] transition-colors px-2 py-1 rounded-lg border border-[var(--color-border-muted)] hover:border-[var(--color-border)]" title="New Folder">
          + Folder
        </button>
        <button @click="refreshAll()" class="text-xs text-[var(--color-text-muted)] hover:text-[var(--color-text-secondary)] transition-colors" title="Refresh">
          ‚Üª
        </button>
      </div>
    </div>

    <!-- File tree -->
    <div class="file-tree text-[var(--color-text-secondary)] max-h-[500px] overflow-y-auto overflow-x-hidden rounded-xl bg-[var(--color-surface-overlay)] p-2"
         @contextmenu.prevent="onBgContext($event)" @click="ctxMenu.show = false">

      <template x-if="treeLoading">
        <div class="flex items-center gap-2 p-4 text-sm text-[var(--color-text-muted)]">
          <svg class="w-4 h-4 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
          Loading‚Ä¶
        </div>
      </template>

      <template x-if="!treeLoading && visibleNodes.length === 0">
        <div class="p-4 text-sm text-[var(--color-text-muted)] italic text-center">Empty directory</div>
      </template>

      <!-- Flat list of visible nodes with depth-based indentation -->
      <template x-for="vn in visibleNodes" :key="vn.path">
        <div class="file-tree-item"
             :class="{ 'selected': selectedPath === vn.path, 'drag-over': dragOverPath === vn.path }"
             :style="'padding-left:' + (vn.depth * 18 + 8) + 'px'"
             draggable="true"
             @contextmenu.prevent.stop="onNodeContext($event, vn)"
             @click.stop="onNodeClick(vn)"
             @dblclick.stop="onNodeDblClick(vn)"
             @dragstart="onDragStart($event, vn)"
             @dragover.prevent="onDragOver($event, vn)"
             @dragenter.prevent="onDragEnter($event, vn)"
             @dragleave="onDragLeave($event, vn)"
             @drop.prevent="onDrop($event, vn)"
             @dragend="onDragEnd()">
          <!-- Expand arrow (dirs) -->
          <template x-if="vn.type === 'directory'">
            <span class="tree-arrow" :class="{ 'expanded': expandedSet[vn.path] }">‚ñ∂</span>
          </template>
          <template x-if="vn.type !== 'directory'">
            <span style="width:16px;display:inline-block;flex-shrink:0;"></span>
          </template>
          <!-- Icon -->
          <span class="text-xs flex-shrink-0" x-text="vn.type === 'directory' ? (expandedSet[vn.path] ? 'üìÇ' : 'üìÅ') : fileIcon(vn.name)"></span>
          <!-- Name or inline rename -->
          <template x-if="renamingPath !== vn.path">
            <span class="truncate flex-1 min-w-0" x-text="vn.name"></span>
          </template>
          <template x-if="renamingPath === vn.path">
            <input class="inline-rename flex-1" x-model="renameValue"
                   @keydown.enter.stop="confirmRename(vn)"
                   @keydown.escape.stop="cancelRename()"
                   @blur="confirmRename(vn)"
                   @click.stop
                   x-init="$nextTick(() => { $el.focus(); $el.select(); })" />
          </template>
          <!-- File size -->
          <span x-show="vn.type === 'file' && vn.size != null"
                class="text-[var(--color-text-muted)] text-[11px] ml-auto flex-shrink-0"
                x-text="fmtBytes(vn.size)"></span>
        </div>
      </template>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Context Menu (fixed-position) ‚îÄ‚îÄ‚îÄ -->
    <div x-show="ctxMenu.show" x-cloak x-transition.opacity.duration.100ms
         class="ctx-menu" :style="'left:'+ctxMenu.x+'px;top:'+ctxMenu.y+'px'"
         @click.outside="ctxMenu.show = false">
      <!-- Node context -->
      <template x-if="ctxMenu.node">
        <div>
          <div class="ctx-menu-item" @click="onNodeDblClick(ctxMenu.node)" x-show="ctxMenu.node.type === 'file'">
            <span>üìÑ</span> Open
          </div>
          <div class="ctx-menu-item" @click="onNodeClick(ctxMenu.node)" x-show="ctxMenu.node.type === 'directory'">
            <span>üìÇ</span> <span x-text="expandedSet[ctxMenu.node.path] ? 'Collapse' : 'Expand'"></span>
          </div>
          <div class="ctx-menu-divider"></div>
          <div class="ctx-menu-item" @click="startRename(ctxMenu.node)">
            <span>‚úèÔ∏è</span> Rename
          </div>
          <div class="ctx-menu-item" @click="promptNewFile(ctxMenu.node.type === 'directory' ? ctxMenu.node.path : parentOf(ctxMenu.node.path))">
            <span>üìÑ</span> New File Here
          </div>
          <div class="ctx-menu-item" @click="promptNewFolder(ctxMenu.node.type === 'directory' ? ctxMenu.node.path : parentOf(ctxMenu.node.path))">
            <span>üìÅ</span> New Folder Here
          </div>
          <div class="ctx-menu-divider"></div>
          <div class="ctx-menu-item danger" @click="deleteNode(ctxMenu.node)">
            <span>üóëÔ∏è</span> Delete
          </div>
        </div>
      </template>
      <!-- Background context -->
      <template x-if="!ctxMenu.node">
        <div>
          <div class="ctx-menu-item" @click="promptNewFile('')"><span>üìÑ</span> New File</div>
          <div class="ctx-menu-item" @click="promptNewFolder('')"><span>üìÅ</span> New Folder</div>
          <div class="ctx-menu-divider"></div>
          <div class="ctx-menu-item" @click="refreshAll()"><span>‚Üª</span> Refresh</div>
        </div>
      </template>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ Prompt Dialog ‚îÄ‚îÄ‚îÄ -->
    <template x-if="prompt.show">
      <div class="prompt-overlay" @click.self="prompt.show = false">
        <div class="prompt-box" @keydown.escape.stop="prompt.show = false">
          <div class="text-sm font-semibold text-[var(--color-text-primary)]" x-text="prompt.title"></div>
          <input class="prompt-input" x-model="prompt.value"
                 @keydown.enter="promptConfirm()" :placeholder="prompt.placeholder"
                 x-init="$nextTick(() => $el.focus())" />
          <div class="flex justify-end gap-2">
            <button @click="prompt.show = false"
                    class="text-xs px-4 py-2 rounded-lg border border-[var(--color-border-muted)] text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors">
              Cancel
            </button>
            <button @click="promptConfirm()"
                    class="text-xs px-4 py-2 rounded-lg bg-[var(--color-accent)] text-white hover:bg-[var(--color-accent-hover)] transition-colors">
              <span x-text="prompt.actionLabel"></span>
            </button>
          </div>
        </div>
      </div>
    </template>

    <!-- ‚îÄ‚îÄ‚îÄ File Editor Modal ‚îÄ‚îÄ‚îÄ -->
    <template x-if="editor.show">
      <div class="modal-overlay" @click.self="closeEditor()">
        <div class="modal-box" @keydown.escape.stop="closeEditor()">
          <div class="modal-header">
            <span class="text-lg">üìÑ</span>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-[var(--color-text-primary)] truncate" x-text="editor.path"></div>
              <div class="text-[11px] text-[var(--color-text-muted)]">
                <span x-text="fmtBytes(editor.size)"></span>
                <template x-if="editor.modified">
                  <span> ¬∑ <span x-text="new Date(editor.modified).toLocaleString()"></span></span>
                </template>
                <template x-if="editor.dirty">
                  <span class="text-[var(--color-warning)]"> ¬∑ Unsaved</span>
                </template>
              </div>
            </div>
            <div class="flex gap-2">
              <template x-if="!editor.binary && !editor.readError">
                <button @click="saveFile()"
                        class="text-xs px-4 py-1.5 rounded-lg bg-[var(--color-accent)] text-white hover:bg-[var(--color-accent-hover)] transition-colors disabled:opacity-50"
                        :disabled="editor.saving">
                  <span x-text="editor.saving ? 'Saving‚Ä¶' : 'Save'"></span>
                </button>
              </template>
              <button @click="closeEditor()"
                      class="text-xs px-3 py-1.5 rounded-lg border border-[var(--color-border-muted)] text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors">
                ‚úï
              </button>
            </div>
          </div>
          <div class="modal-body">
            <template x-if="editor.loading">
              <div class="flex items-center justify-center h-full text-sm text-[var(--color-text-muted)]">
                <svg class="w-5 h-5 spinner mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                Loading‚Ä¶
              </div>
            </template>
            <template x-if="editor.readError">
              <div class="flex items-center justify-center h-full text-sm text-[#f87171]" x-text="editor.readError"></div>
            </template>
            <template x-if="editor.binary">
              <div class="flex flex-col items-center justify-center h-full gap-2 text-[var(--color-text-muted)]">
                <span class="text-4xl">üîí</span>
                <p class="text-sm">Binary file ‚Äî cannot edit</p>
                <p class="text-xs" x-text="fmtBytes(editor.size)"></p>
              </div>
            </template>
            <template x-if="!editor.loading && !editor.readError && !editor.binary">
              <textarea x-model="editor.content" @input="editor.dirty = true"
                        spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
            </template>
          </div>
          <div class="modal-footer">
            <div class="text-[11px] text-[var(--color-text-muted)]">
              <template x-if="editor.saveMsg">
                <span :class="editor.saveError ? 'text-[#f87171]' : 'text-[#4ade80]'" x-text="editor.saveMsg"></span>
              </template>
            </div>
            <div class="text-[11px] text-[var(--color-text-muted)]">Ctrl+S to save</div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Footer -->
  <div class="text-center text-xs text-[var(--color-text-muted)] pb-8">
    Auto-refreshes every 30s ¬∑ <span x-text="lastRefresh"></span>
  </div>

</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AGENTS DASHBOARD ‚Äî main component
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function agentsDashboard() {
  return {
    loading: false, error: null,
    overview: {}, status: {}, fsData: {},
    showFs: false, lastRefresh: '', _interval: null,

    selectedVizAgent: null,

    async init() {
      await this.refresh();
      this._interval = setInterval(() => this.refresh(), 30000);
      window.__dashData = this;
    },
    async httpJson(url) {
      const r = await fetch(url, { credentials: 'same-origin' });
      if (!r.ok) { const t = await r.text(); throw new Error('HTTP ' + r.status + ': ' + (t || r.statusText)); }
      return r.json();
    },
    async refresh() {
      this.loading = true; this.error = null;
      try {
        const [overview, status, fsData] = await Promise.all([
          this.httpJson('/agents/api/overview'),
          this.httpJson('/agents/api/status'),
          this.httpJson('/agents/api/filesystem'),
        ]);
        this.overview = overview; this.status = status; this.fsData = fsData;
        this.lastRefresh = new Date().toLocaleTimeString();
      } catch (err) { this.error = err.message; }
      finally { this.loading = false; }
    },
    get channelCount() { return Object.keys(this.overview.channels || {}).length; },
    get deviceCount()  { return Array.isArray(this.status.devices) ? this.status.devices.length : 0; },
    get gatewayOk()    { return this.status.gateway?.running && this.status.gateway?.reachable; },

    channelIcon(n)  { return ({ telegram:'‚úàÔ∏è',discord:'üéÆ',slack:'üí¨',whatsapp:'üì±',matrix:'üîó',irc:'üíª' })[n.toLowerCase()] || 'üì°'; },
    channelColor(n) { return ({ telegram:'#2AABEE',discord:'#5865F2',slack:'#E01E5A',whatsapp:'#25D366',matrix:'#0DBD8B',irc:'#A970FF' })[n.toLowerCase()] || '#e63946'; },
    providerIcon(n) { return ({ openai:'ü§ñ',anthropic:'üß†',google:'üîç',openrouter:'üåê',copilot:'üêô',moonshot:'üåô',qwen:'üå∏',minimax:'‚ö°',synthetic:'üß™',gemini:'üíé',profiles:'üîë' })[n.toLowerCase()] || 'üîë'; },
    channelDetails(cfg) {
      const skip = new Set(['enabled','hasToken','token','botToken','appToken']);
      const out = {};
      for (const [k,v] of Object.entries(cfg)) { if (!skip.has(k) && typeof v !== 'object') out[k] = v; }
      return out;
    },
    formatBytes(b) {
      if (b == null) return '‚Äî'; if (b === 0) return '0 B';
      const u = ['B','KB','MB','GB'], i = Math.min(Math.floor(Math.log(b)/Math.log(1024)), u.length-1);
      return (b/Math.pow(1024,i)).toFixed(i===0?0:1)+' '+u[i];
    },
    formatUptime(s) {
      if (!s) return '‚Äî';
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
      return h > 0 ? h+'h '+m+'m' : m > 0 ? m+'m' : Math.floor(s)+'s';
    },
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILE EXPLORER ‚Äî uses a flat visible-node list
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fileExplorer() {
  return {
    currentRoot: 'workspace',
    // Hierarchical tree (nodes with .children arrays)
    _tree: [],
    treeLoading: false,
    // Track which directory paths are expanded
    expandedSet: {},
    selectedPath: null,
    // Rename
    renamingPath: null,
    renameValue: '',
    // Drag & drop
    dragPath: null,
    dragOverPath: null,
    // Context menu
    ctxMenu: { show: false, x: 0, y: 0, node: null },
    // Prompt dialog
    prompt: { show: false, title: '', placeholder: '', value: '', actionLabel: 'Create', _cb: null },
    // Editor modal
    editor: {
      show: false, loading: false, saving: false,
      path: '', content: '', size: 0, modified: null,
      binary: false, readError: null, dirty: false,
      saveMsg: '', saveError: false,
    },

    async init() {
      await this.refreshAll();
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's' && this.editor.show) {
          e.preventDefault(); this.saveFile();
        }
      });
    },

    /* ‚îÄ‚îÄ Computed flat list of visible nodes ‚îÄ‚îÄ */
    get visibleNodes() {
      const list = [];
      const walk = (nodes, depth) => {
        for (const n of nodes) {
          list.push({ ...n, depth, _children: undefined });
          if (n.type === 'directory' && this.expandedSet[n.path] && n.children?.length) {
            walk(n.children, depth + 1);
          }
        }
      };
      walk(this._tree, 0);
      return list;
    },

    /* ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ */
    async _api(url, opts) {
      const r = await fetch(url, { credentials: 'same-origin', ...opts });
      const d = await r.json();
      if (!d.ok) throw new Error(d.error || 'Request failed');
      return d;
    },

    /* ‚îÄ‚îÄ Load / refresh ‚îÄ‚îÄ */
    async refreshAll() {
      this.treeLoading = true;
      this.expandedSet = {};
      try { await this._loadDir(''); } catch(e) { console.error(e); }
      this.treeLoading = false;
    },

    switchRoot(root) {
      this.currentRoot = root;
      this._tree = [];
      this.refreshAll();
    },

    async _loadDir(dirPath) {
      const data = await this._api(`/agents/api/fs/list?root=${this.currentRoot}&dir=${encodeURIComponent(dirPath)}`);
      const entries = (data.entries || []).map(e => ({
        name: e.name, type: e.type, path: e.path,
        size: e.size, modified: e.modified,
        hasChildren: e.hasChildren,
        children: [],
      }));
      if (dirPath === '') {
        this._tree = entries;
      } else {
        this._setChildren(this._tree, dirPath, entries);
      }
    },

    _setChildren(nodes, target, children) {
      for (const n of nodes) {
        if (n.path === target) { n.children = children; return true; }
        if (n.children?.length && this._setChildren(n.children, target, children)) return true;
      }
      return false;
    },

    /* ‚îÄ‚îÄ Click handlers ‚îÄ‚îÄ */
    onNodeClick(vn) {
      this.ctxMenu.show = false;
      this.selectedPath = vn.path;
      if (vn.type === 'directory') {
        if (this.expandedSet[vn.path]) {
          delete this.expandedSet[vn.path];
          // Force reactivity
          this.expandedSet = { ...this.expandedSet };
        } else {
          this.expandedSet[vn.path] = true;
          this.expandedSet = { ...this.expandedSet };
          this._loadDir(vn.path);
        }
      }
    },

    onNodeDblClick(vn) {
      if (vn.type === 'file') this.openFile(vn);
    },

    /* ‚îÄ‚îÄ Open / edit file ‚îÄ‚îÄ */
    async openFile(vn) {
      this.ctxMenu.show = false;
      this.selectedPath = vn.path;
      this.editor = {
        show: true, loading: true, saving: false,
        path: vn.path, content: '', size: vn.size || 0,
        modified: vn.modified, binary: false, readError: null,
        dirty: false, saveMsg: '', saveError: false,
      };
      try {
        const d = await this._api(`/agents/api/fs/read?root=${this.currentRoot}&filePath=${encodeURIComponent(vn.path)}`);
        if (d.binary) {
          this.editor.binary = true; this.editor.size = d.size;
        } else {
          this.editor.content = d.content; this.editor.size = d.size; this.editor.modified = d.modified;
        }
      } catch (e) { this.editor.readError = e.message; }
      finally { this.editor.loading = false; }
    },

    async saveFile() {
      if (this.editor.saving || this.editor.binary) return;
      this.editor.saving = true; this.editor.saveMsg = '';
      try {
        await this._api('/agents/api/fs/write', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ root: this.currentRoot, filePath: this.editor.path, content: this.editor.content }),
        });
        this.editor.dirty = false;
        this.editor.saveMsg = '‚úì Saved'; this.editor.saveError = false;
        setTimeout(() => { if (this.editor.saveMsg === '‚úì Saved') this.editor.saveMsg = ''; }, 3000);
      } catch (e) { this.editor.saveMsg = 'Failed: ' + e.message; this.editor.saveError = true; }
      finally { this.editor.saving = false; }
    },

    closeEditor() {
      if (this.editor.dirty && !confirm('Unsaved changes will be lost. Close?')) return;
      this.editor.show = false;
    },

    closeAll() {
      this.ctxMenu.show = false;
      if (this.prompt.show) { this.prompt.show = false; return; }
      if (this.editor.show) { this.closeEditor(); }
    },

    /* ‚îÄ‚îÄ Context menu ‚îÄ‚îÄ */
    onNodeContext(ev, vn) {
      ev.preventDefault(); ev.stopPropagation();
      this.selectedPath = vn.path;
      this.ctxMenu = {
        show: true, node: vn,
        x: Math.min(ev.clientX, window.innerWidth - 200),
        y: Math.min(ev.clientY, window.innerHeight - 280),
      };
    },
    onBgContext(ev) {
      ev.preventDefault();
      this.ctxMenu = {
        show: true, node: null,
        x: Math.min(ev.clientX, window.innerWidth - 200),
        y: Math.min(ev.clientY, window.innerHeight - 160),
      };
    },

    /* ‚îÄ‚îÄ Create new file / folder ‚îÄ‚îÄ */
    promptNewFile(parentPath) {
      this.ctxMenu.show = false;
      if (parentPath && !this.expandedSet[parentPath]) {
        this.expandedSet[parentPath] = true;
        this.expandedSet = { ...this.expandedSet };
        this._loadDir(parentPath);
      }
      this.prompt = {
        show: true, title: 'New File', placeholder: 'filename.txt', value: '', actionLabel: 'Create',
        _cb: async (name) => {
          const fp = parentPath ? parentPath + '/' + name : name;
          await this._api('/agents/api/fs/write', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ root: this.currentRoot, filePath: fp, content: '' }),
          });
          await this._reloadParent(parentPath);
        },
      };
    },
    promptNewFolder(parentPath) {
      this.ctxMenu.show = false;
      if (parentPath && !this.expandedSet[parentPath]) {
        this.expandedSet[parentPath] = true;
        this.expandedSet = { ...this.expandedSet };
        this._loadDir(parentPath);
      }
      this.prompt = {
        show: true, title: 'New Folder', placeholder: 'folder-name', value: '', actionLabel: 'Create',
        _cb: async (name) => {
          const dp = parentPath ? parentPath + '/' + name : name;
          await this._api('/agents/api/fs/mkdir', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ root: this.currentRoot, dirPath: dp }),
          });
          await this._reloadParent(parentPath);
        },
      };
    },
    async promptConfirm() {
      const v = this.prompt.value.trim();
      if (!v) return;
      try { await this.prompt._cb(v); } catch (e) { alert('Error: ' + e.message); }
      this.prompt.show = false;
    },

    /* ‚îÄ‚îÄ Rename ‚îÄ‚îÄ */
    startRename(vn) {
      this.ctxMenu.show = false;
      this.renamingPath = vn.path;
      this.renameValue = vn.name;
    },
    cancelRename() { this.renamingPath = null; },
    async confirmRename(vn) {
      const newName = this.renameValue.trim();
      this.renamingPath = null;
      if (!newName || newName === vn.name) return;
      const parent = this.parentOf(vn.path);
      const newPath = parent ? parent + '/' + newName : newName;
      try {
        await this._api('/agents/api/fs/rename', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ root: this.currentRoot, oldPath: vn.path, newPath }),
        });
        await this._reloadParent(parent);
      } catch (e) { alert('Rename failed: ' + e.message); }
    },

    /* ‚îÄ‚îÄ Delete ‚îÄ‚îÄ */
    async deleteNode(vn) {
      this.ctxMenu.show = false;
      const label = vn.type === 'directory' ? `folder "${vn.name}" and all contents` : `file "${vn.name}"`;
      if (!confirm('Delete ' + label + '?')) return;
      const parent = this.parentOf(vn.path);
      try {
        await this._api('/agents/api/fs/delete', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ root: this.currentRoot, targetPath: vn.path }),
        });
        await this._reloadParent(parent);
      } catch (e) { alert('Delete failed: ' + e.message); }
    },

    /* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ */
    onDragStart(ev, vn) {
      this.dragPath = vn.path;
      ev.dataTransfer.effectAllowed = 'move';
      ev.dataTransfer.setData('text/plain', vn.path);
    },
    onDragOver(ev, vn) {
      if (!this.dragPath || vn.type !== 'directory' || vn.path === this.dragPath) return;
      if (vn.path.startsWith(this.dragPath + '/')) return;
      ev.dataTransfer.dropEffect = 'move';
    },
    onDragEnter(ev, vn) {
      if (!this.dragPath || vn.type !== 'directory' || vn.path === this.dragPath) return;
      if (vn.path.startsWith(this.dragPath + '/')) return;
      this.dragOverPath = vn.path;
    },
    onDragLeave(ev, vn) {
      if (this.dragOverPath === vn.path) this.dragOverPath = null;
    },
    async onDrop(ev, targetVn) {
      this.dragOverPath = null;
      if (!this.dragPath || targetVn.type !== 'directory' || targetVn.path === this.dragPath) { this.dragPath = null; return; }
      if (targetVn.path.startsWith(this.dragPath + '/')) { this.dragPath = null; return; }
      const srcName = this.dragPath.includes('/') ? this.dragPath.split('/').pop() : this.dragPath;
      const srcParent = this.parentOf(this.dragPath);
      const newPath = targetVn.path + '/' + srcName;
      try {
        await this._api('/agents/api/fs/rename', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ root: this.currentRoot, oldPath: this.dragPath, newPath }),
        });
        await this._reloadParent(srcParent);
        if (this.expandedSet[targetVn.path]) await this._loadDir(targetVn.path);
      } catch (e) { alert('Move failed: ' + e.message); }
      this.dragPath = null;
    },
    onDragEnd() { this.dragPath = null; this.dragOverPath = null; },

    /* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
    parentOf(p)  { const i = p.lastIndexOf('/'); return i > 0 ? p.substring(0, i) : ''; },
    async _reloadParent(p) { await this._loadDir(p || ''); },

    fileIcon(name) {
      const ext = name.includes('.') ? name.split('.').pop().toLowerCase() : '';
      return ({
        js:'üü®',mjs:'üü®',cjs:'üü®', ts:'üî∑',mts:'üî∑', jsx:'‚öõÔ∏è',tsx:'‚öõÔ∏è',
        json:'üìã',yaml:'üìã',yml:'üìã',toml:'üìã',xml:'üìã',
        md:'üìù',txt:'üìù',log:'üìù',csv:'üìù',
        html:'üåê',htm:'üåê', css:'üé®',scss:'üé®',less:'üé®',
        py:'üêç',rb:'üíé',go:'üîµ',rs:'ü¶Ä',java:'‚òï',kt:'‚òï',
        sh:'‚öôÔ∏è',bash:'‚öôÔ∏è',zsh:'‚öôÔ∏è',fish:'‚öôÔ∏è',ps1:'‚öôÔ∏è',
        png:'üñºÔ∏è',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',gif:'üñºÔ∏è',svg:'üñºÔ∏è',webp:'üñºÔ∏è',ico:'üñºÔ∏è',
        zip:'üì¶',tar:'üì¶',gz:'üì¶',bz2:'üì¶',rar:'üì¶','7z':'üì¶',
        lock:'üîí',env:'üîê',
        pdf:'üìï',doc:'üìò',docx:'üìò',
        mp3:'üéµ',wav:'üéµ',mp4:'üé¨',mov:'üé¨',
        wasm:'üü£',sql:'üóÉÔ∏è',db:'üóÉÔ∏è',sqlite:'üóÉÔ∏è',
      })[ext] || 'üìÑ';
    },

    fmtBytes(b) {
      if (b == null) return '‚Äî'; if (b === 0) return '0 B';
      const u = ['B','KB','MB','GB'], i = Math.min(Math.floor(Math.log(b)/Math.log(1024)), u.length-1);
      return (b/Math.pow(1024,i)).toFixed(i===0?0:1)+' '+u[i];
    },
  };
}
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     OFFICE VISUALIZATION ‚Äî Zdog Pok√©mon-style isometric view
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
(function() {
  'use strict';

  /* ‚îÄ‚îÄ Boot: wait for Zdog + Alpine data ‚îÄ‚îÄ */
  function boot() {
    if (typeof Zdog === 'undefined' || !window.__dashData) {
      requestAnimationFrame(boot);
      return;
    }
    buildViz(window.__dashData);
  }

  function buildViz(dash) {
    const TAU = Zdog.TAU;
    const canvas = document.getElementById('officeViz');
    const labelsEl = document.getElementById('officeLabels');
    if (!canvas || !labelsEl) return;

    /* ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ */
    const officeW = 500, officeD = 300, wallH = 70;
    const AGENT_COLORS = [
      '#e63946', '#5577cc', '#cc7744', '#aa55aa',
      '#44aaaa', '#22c55e', '#88aa44', '#cc8844'
    ];
    const DESK_SLOTS = [
      { x: -160, z: -60 }, { x: -30, z: -60 }, { x: 100, z: -60 },
      { x: -160, z:  70 }, { x: -30, z:  70 }, { x: 100, z:  70 },
      { x:  200, z: -20 }, { x:  200, z:  50 },
    ];

    /* ‚îÄ‚îÄ‚îÄ Illustration ‚îÄ‚îÄ‚îÄ */
    const illo = new Zdog.Illustration({
      element: canvas,
      resize: true,
      centered: true,
      zoom: 1,
      rotate: { x: -TAU / 8, y: TAU / 8 },
      onResize: function(w) {
        this.zoom = Math.max(0.45, Math.min(1.4, w / 880));
      },
    });

    const world = new Zdog.Anchor({ addTo: illo });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Build Office Room ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    // Floor
    new Zdog.Box({
      addTo: world,
      width: officeW, height: 4, depth: officeD,
      stroke: false,
      color: '#252540',
      topFace: '#2a2a48',
      bottomFace: '#1e1e36',
      leftFace: '#222240', rightFace: '#222240',
      frontFace: '#222240', rearFace: '#222240',
    });

    // Floor grid lines for Pok√©mon style
    for (let gx = -officeW / 2 + 50; gx < officeW / 2; gx += 50) {
      new Zdog.Shape({
        addTo: world,
        path: [{ x: gx, y: -2.5, z: -officeD / 2 }, { x: gx, y: -2.5, z: officeD / 2 }],
        closed: false, stroke: 1, color: 'rgba(255,255,255,0.04)',
      });
    }
    for (let gz = -officeD / 2 + 50; gz < officeD / 2; gz += 50) {
      new Zdog.Shape({
        addTo: world,
        path: [{ x: -officeW / 2, y: -2.5, z: gz }, { x: officeW / 2, y: -2.5, z: gz }],
        closed: false, stroke: 1, color: 'rgba(255,255,255,0.04)',
      });
    }

    // Back wall
    new Zdog.Box({
      addTo: world,
      width: officeW, height: wallH, depth: 5,
      translate: { y: -wallH / 2, z: -officeD / 2 },
      stroke: false, color: '#1e1e3a',
      frontFace: '#282848',
    });

    // Left wall
    new Zdog.Box({
      addTo: world,
      width: 5, height: wallH, depth: officeD,
      translate: { x: -officeW / 2, y: -wallH / 2 },
      stroke: false, color: '#1a1a34',
      rightFace: '#242444',
    });

    // Right wall (short, for visibility)
    new Zdog.Box({
      addTo: world,
      width: 5, height: wallH * 0.35, depth: officeD,
      translate: { x: officeW / 2, y: -wallH * 0.175 },
      stroke: false, color: 'rgba(40,40,70,0.4)',
    });

    // Front wall (very short)
    new Zdog.Box({
      addTo: world,
      width: officeW, height: wallH * 0.25, depth: 5,
      translate: { y: -wallH * 0.125, z: officeD / 2 },
      stroke: false, color: 'rgba(40,40,70,0.3)',
    });

    // ‚îÄ‚îÄ Window on back wall ‚îÄ‚îÄ
    new Zdog.Rect({
      addTo: world,
      width: 80, height: 40,
      translate: { x: 0, y: -wallH * 0.55, z: -officeD / 2 + 3.5 },
      stroke: 2, color: '#3a3a60',
      fill: true,
    });
    // Window glow
    new Zdog.Rect({
      addTo: world,
      width: 72, height: 34,
      translate: { x: 0, y: -wallH * 0.55, z: -officeD / 2 + 4 },
      stroke: 0, color: 'rgba(100,140,200,0.15)',
      fill: true,
    });

    // ‚îÄ‚îÄ Plant in corner ‚îÄ‚îÄ
    (function addPlant() {
      const pa = new Zdog.Anchor({ addTo: world, translate: { x: -officeW / 2 + 25, y: 0, z: -officeD / 2 + 25 } });
      // Pot
      new Zdog.Cylinder({
        addTo: pa, diameter: 14, length: 12,
        translate: { y: -6 },
        stroke: false, color: '#6B4226', frontFace: '#8B5A2B',
      });
      // Leaves (spheres)
      new Zdog.Shape({ addTo: pa, stroke: 18, color: '#2d8a4e', translate: { y: -22 } });
      new Zdog.Shape({ addTo: pa, stroke: 13, color: '#35a05a', translate: { y: -18, x: 6 } });
      new Zdog.Shape({ addTo: pa, stroke: 11, color: '#40b868', translate: { y: -26, x: -3 } });
    })();

    // ‚îÄ‚îÄ Plant in other corner ‚îÄ‚îÄ
    (function addPlant2() {
      const pa = new Zdog.Anchor({ addTo: world, translate: { x: officeW / 2 - 25, y: 0, z: -officeD / 2 + 25 } });
      new Zdog.Cylinder({
        addTo: pa, diameter: 10, length: 10,
        translate: { y: -5 }, stroke: false, color: '#6B4226',
      });
      new Zdog.Shape({ addTo: pa, stroke: 14, color: '#2d8a4e', translate: { y: -18 } });
      new Zdog.Shape({ addTo: pa, stroke: 10, color: '#40b868', translate: { y: -22, x: 4 } });
    })();

    /* ‚îÄ‚îÄ‚îÄ Build Desks ‚îÄ‚îÄ‚îÄ */
    function addDesk(px, pz) {
      const da = new Zdog.Anchor({ addTo: world, translate: { x: px, z: pz } });
      // Surface
      new Zdog.Box({
        addTo: da,
        width: 52, height: 4, depth: 28,
        translate: { y: -20 },
        stroke: false, color: '#3a3a5c', topFace: '#44446a',
      });
      // Legs
      var legColor = '#2e2e4a';
      new Zdog.Box({ addTo: da, width: 3, height: 17, depth: 3, translate: { x: -22, y: -10, z: 10 }, stroke: false, color: legColor });
      new Zdog.Box({ addTo: da, width: 3, height: 17, depth: 3, translate: { x:  22, y: -10, z: 10 }, stroke: false, color: legColor });
      new Zdog.Box({ addTo: da, width: 3, height: 17, depth: 3, translate: { x: -22, y: -10, z:-10 }, stroke: false, color: legColor });
      new Zdog.Box({ addTo: da, width: 3, height: 17, depth: 3, translate: { x:  22, y: -10, z:-10 }, stroke: false, color: legColor });
      // Monitor
      new Zdog.Box({
        addTo: da,
        width: 22, height: 15, depth: 2,
        translate: { y: -31, z: -5 },
        stroke: false, color: '#222', frontFace: '#4488aa',
      });
      // Monitor stand
      new Zdog.Box({ addTo: da, width: 4, height: 8, depth: 2, translate: { y: -24, z: -5 }, stroke: false, color: '#333' });
      // Chair (simple)
      new Zdog.Box({
        addTo: da,
        width: 16, height: 3, depth: 16,
        translate: { y: -12, z: 20 },
        stroke: false, color: '#e63946', topFace: '#f04d5a',
      });
      new Zdog.Box({
        addTo: da, width: 16, height: 14, depth: 3,
        translate: { y: -20, z: 26 },
        stroke: false, color: '#c02030',
      });
    }
    DESK_SLOTS.forEach(function(s) { addDesk(s.x, s.z); });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Agent Figure Factory ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const agentMeshes = new Map();

    function createAgentFigure(color, scale) {
      var s = scale || 1;
      var anchor = new Zdog.Anchor({ addTo: world });

      // Torso
      new Zdog.Box({
        addTo: anchor,
        width: 14 * s, height: 16 * s, depth: 8 * s,
        translate: { y: -10 * s },
        stroke: false, color: color,
      });
      // Arms
      new Zdog.Shape({
        addTo: anchor,
        path: [{ y: 0 }, { y: 10 * s }],
        translate: { x: -9 * s, y: -16 * s },
        stroke: 4 * s, color: color,
      });
      new Zdog.Shape({
        addTo: anchor,
        path: [{ y: 0 }, { y: 10 * s }],
        translate: { x: 9 * s, y: -16 * s },
        stroke: 4 * s, color: color,
      });
      // Head
      new Zdog.Shape({
        addTo: anchor,
        stroke: 12 * s,
        color: '#f2c9a0',
        translate: { y: -24 * s },
      });
      // Hair/hat
      new Zdog.Shape({
        addTo: anchor,
        stroke: 8 * s,
        color: color,
        translate: { y: -29 * s },
      });
      // Left leg
      new Zdog.Shape({
        addTo: anchor,
        path: [{ y: 0 }, { y: 10 * s }],
        translate: { x: -4 * s, y: -2 * s },
        stroke: 4.5 * s, color: '#3a3a5c',
      });
      // Right leg
      new Zdog.Shape({
        addTo: anchor,
        path: [{ y: 0 }, { y: 10 * s }],
        translate: { x: 4 * s, y: -2 * s },
        stroke: 4.5 * s, color: '#3a3a5c',
      });
      // Selection ring (hidden)
      var ring = new Zdog.Ellipse({
        addTo: anchor,
        diameter: 26 * s,
        translate: { y: 2 },
        rotate: { x: TAU / 4 },
        stroke: 2.5, color: 'rgba(230,57,70,0)',
        fill: false,
      });

      return { anchor: anchor, ring: ring };
    }

    /* ‚îÄ‚îÄ‚îÄ DOM Labels ‚îÄ‚îÄ‚îÄ */
    function createLabelEl(name, state) {
      var el = document.createElement('div');
      el.className = 'agentLabel';
      var dotColor = state === 'working' ? '#22c55e' : (state === 'starting' ? '#eab308' : '#71717a');
      el.innerHTML =
        '<div class="agentName">' + name + '</div>' +
        '<div class="agentStatus">' +
          '<span class="statusDot" style="background:' + dotColor + '"></span>' +
          '<span class="statusText">' + state + '</span>' +
        '</div>';
      labelsEl.appendChild(el);
      return el;
    }

    /* ‚îÄ‚îÄ‚îÄ 3D ‚Üí 2D Projection (fixed isometric camera) ‚îÄ‚îÄ‚îÄ */
    var rotX = -TAU / 8, rotY = TAU / 8;
    var cosRX = Math.cos(rotX), sinRX = Math.sin(rotX);
    var cosRY = Math.cos(rotY), sinRY = Math.sin(rotY);

    function project(x, y, z) {
      var rx = x * cosRY + z * sinRY;
      var rz = -x * sinRY + z * cosRY;
      var ry = y * cosRX - rz * sinRX;
      return { sx: rx, sy: ry };
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê State ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    var selectedId = null;
    var frameCount = 0;
    var lastDataHash = '';

    function getAgentList() {
      var agents = [];
      var gwOk = dash.status && dash.status.gateway &&
                 dash.status.gateway.running && dash.status.gateway.reachable;

      // Main agent
      agents.push({
        id: '__main__', name: 'Main Agent',
        state: gwOk ? 'working' : (dash.status && dash.status.gateway && dash.status.gateway.starting ? 'starting' : 'idle'),
        isSub: false, parentId: null, slotIndex: 0,
      });

      // Channel agents
      var channels = (dash.overview && dash.overview.channels) || {};
      var idx = 1;
      for (var chName in channels) {
        if (!channels.hasOwnProperty(chName)) continue;
        var cfg = channels[chName];
        agents.push({
          id: 'ch_' + chName,
          name: chName.charAt(0).toUpperCase() + chName.slice(1),
          state: (cfg.enabled && gwOk) ? 'working' : (cfg.enabled ? 'starting' : 'idle'),
          isSub: false, parentId: null, slotIndex: idx,
        });
        idx++;
      }

      // Sub-agents
      var maxSub = (dash.overview && dash.overview.agents &&
                    dash.overview.agents.subagents &&
                    dash.overview.agents.subagents.maxConcurrent) || 0;
      for (var si = 0; si < Math.min(maxSub, 6); si++) {
        agents.push({
          id: 'sub_' + si,
          name: 'Sub-agent ' + (si + 1),
          state: 'idle',
          isSub: true, parentId: '__main__', slotIndex: si,
        });
      }

      return agents;
    }

    /* ‚îÄ‚îÄ‚îÄ Build / rebuild agent meshes ‚îÄ‚îÄ‚îÄ */
    function rebuildAgents() {
      agentMeshes.forEach(function(m) {
        m.anchor.remove();
        if (m.labelEl && m.labelEl.parentNode) m.labelEl.parentNode.removeChild(m.labelEl);
        if (m.connector) m.connector.remove();
      });
      agentMeshes.clear();

      var agents = getAgentList();

      agents.forEach(function(ag, i) {
        var scale = ag.isSub ? 0.6 : 1;
        var color = ag.isSub ? '#6699cc' : AGENT_COLORS[i % AGENT_COLORS.length];
        var fig = createAgentFigure(color, scale);

        // Position
        var pos;
        if (ag.isSub) {
          var mainSlot = DESK_SLOTS[0];
          var angle = (ag.slotIndex / Math.max(1, Math.min(6, agents.filter(function(a){return a.isSub;}).length))) * TAU + TAU / 12;
          pos = {
            x: mainSlot.x + Math.cos(angle) * 52,
            z: mainSlot.z + 30 + Math.sin(angle) * 30,
          };
        } else {
          var slot = DESK_SLOTS[ag.slotIndex % DESK_SLOTS.length];
          pos = { x: slot.x, z: slot.z + 28 };
        }

        fig.anchor.translate.x = pos.x;
        fig.anchor.translate.z = pos.z;
        fig.anchor.translate.y = -4;

        // Label
        var labelEl = createLabelEl(ag.name, ag.state);

        // Connector for sub-agents
        var connector = null;
        if (ag.isSub && ag.parentId) {
          connector = new Zdog.Shape({
            addTo: world,
            path: [{ x: 0, y: -10, z: 0 }, { x: 0, y: -10, z: 0 }],
            closed: false, stroke: 1.5,
            color: 'rgba(100,150,210,0.18)',
          });
        }

        agentMeshes.set(ag.id, {
          anchor: fig.anchor, ring: fig.ring,
          labelEl: labelEl, connector: connector,
          agent: ag, pos: { x: pos.x, z: pos.z },
          lastState: ag.state,
          _screenX: 0, _screenY: 0,
        });
      });
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Animation Loop ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function tick() {
      frameCount++;

      // Detect data changes ‚Üí rebuild
      var channels = (dash.overview && dash.overview.channels) || {};
      var chKeys = Object.keys(channels).join(',');
      var maxSub = String((dash.overview && dash.overview.agents &&
                           dash.overview.agents.subagents &&
                           dash.overview.agents.subagents.maxConcurrent) || 0);
      var gwRunning = String(!!(dash.status && dash.status.gateway && dash.status.gateway.running));
      var hash = chKeys + '|' + maxSub + '|' + gwRunning;
      if (hash !== lastDataHash) {
        lastDataHash = hash;
        rebuildAgents();
      }

      // Current agent states
      var currentAgents = getAgentList();
      var agentLookup = {};
      currentAgents.forEach(function(a) { agentLookup[a.id] = a; });

      agentMeshes.forEach(function(m, id) {
        var ag = agentLookup[id];
        if (!ag) return;

        // Idle bob / working bounce
        var speed = ag.state === 'working' ? 0.09 : 0.025;
        var amp = ag.state === 'working' ? 2 : 0.7;
        var bob = Math.sin(frameCount * speed + m.pos.x * 0.05) * amp;
        m.anchor.translate.y = -4 + bob;

        // Working agents: slight body rotation wobble
        if (ag.state === 'working') {
          m.anchor.rotate.y = Math.sin(frameCount * 0.04 + m.pos.x) * 0.08;
        } else {
          m.anchor.rotate.y = 0;
        }

        // Update status label text when changed
        if (ag.state !== m.lastState) {
          m.lastState = ag.state;
          var dotEl = m.labelEl.querySelector('.statusDot');
          var txtEl = m.labelEl.querySelector('.statusText');
          if (txtEl) txtEl.textContent = ag.state;
          if (dotEl) {
            dotEl.style.background = ag.state === 'working' ? '#22c55e' :
                                     ag.state === 'starting' ? '#eab308' : '#71717a';
          }
        }

        // Selection ring
        var isSel = selectedId === id;
        m.ring.color = isSel ? 'rgba(230,57,70,0.7)' : 'rgba(230,57,70,0)';
        if (isSel) {
          m.labelEl.classList.add('selected');
        } else {
          m.labelEl.classList.remove('selected');
        }

        // Connector endpoints
        if (m.connector && ag.parentId) {
          var parent = agentMeshes.get(ag.parentId);
          if (parent) {
            m.connector.path = [
              { x: parent.anchor.translate.x, y: parent.anchor.translate.y - 10, z: parent.anchor.translate.z },
              { x: m.anchor.translate.x, y: m.anchor.translate.y - 6, z: m.anchor.translate.z },
            ];
            m.connector.updatePath();
          }
        }
      });

      // Update DOM label positions
      var wrapRect = canvas.parentElement.getBoundingClientRect();
      var cw = wrapRect.width, ch = wrapRect.height;
      var zoom = illo.zoom;
      var cx = cw / 2, cy = ch / 2;

      agentMeshes.forEach(function(m) {
        // Project head position for label
        var headY = m.anchor.translate.y - (m.agent.isSub ? 22 : 34);
        var p = project(m.anchor.translate.x, headY, m.anchor.translate.z);
        var sx = cx + p.sx * zoom;
        var sy = cy + p.sy * zoom;
        m.labelEl.style.left = sx + 'px';
        m.labelEl.style.top = sy + 'px';

        // Store body center for hit testing
        var bodyP = project(m.anchor.translate.x, m.anchor.translate.y - 12, m.anchor.translate.z);
        m._screenX = cx + bodyP.sx * zoom;
        m._screenY = cy + bodyP.sy * zoom;
      });

      illo.updateRenderGraph();
      requestAnimationFrame(tick);
    }

    /* ‚îÄ‚îÄ‚îÄ Click Hit-Testing ‚îÄ‚îÄ‚îÄ */
    canvas.addEventListener('click', function(e) {
      var wrapRect = canvas.parentElement.getBoundingClientRect();
      var mx = e.clientX - wrapRect.left;
      var my = e.clientY - wrapRect.top;

      var nearId = null;
      var nearDist = 28;

      agentMeshes.forEach(function(m, id) {
        var dx = mx - m._screenX;
        var dy = my - m._screenY;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < nearDist) { nearDist = dist; nearId = id; }
      });

      selectedId = nearId;
      dash.selectedVizAgent = nearId;

      // Scroll corresponding card into view
      if (nearId === '__main__') {
        var hero = document.querySelector('.card.mb-8.relative');
        if (hero) hero.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else if (nearId && nearId.indexOf('ch_') === 0) {
        // Channel cards have the channel name in x-text
        var chName = nearId.slice(3);
        var cards = document.querySelectorAll('.card.viz-selected');
        cards.forEach(function(c) { c.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); });
      }
    });

    // Deselect on click outside viz (optional)
    document.addEventListener('click', function(e) {
      if (!canvas.contains(e.target) && !e.target.closest('.card')) {
        selectedId = null;
        dash.selectedVizAgent = null;
      }
    });

    /* ‚îÄ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ */
    tick();
  }

  // Boot
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    requestAnimationFrame(boot);
  }
})();
</script>
</body>
</html>
